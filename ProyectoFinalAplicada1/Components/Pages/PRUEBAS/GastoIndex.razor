@page "/Empresa/ListaPrecios/Create"
@using Microsoft.AspNetCore.Authorization

@inject ListasPreciosService listasService
@inject ProductosServices productosService
@inject NavigationManager navigationManager

@attribute [Authorize(Roles = "Administrador")]

<PageTitle>Lista de Precios</PageTitle>

<EditForm Model="Lista" OnValidSubmit="Guardar">
    <DataAnnotationsValidator />

    <div class="container">
        <div class="card card-glass rounded-4 p-2">

            @* Título sutil integrado *@
            <div class="card-header bg-transparent border-0 pb-0">
                <h5 class="fw-bold text-muted mb-0">Definir Precios Empresariales</h5>
            </div>

            <div class="card-body">
                @* --- CABECERA --- *@
                <div class="row align-items-end mb-4">
                    <div class="col-md-5">
                        <label class="form-label text-muted small fw-bold mb-1">Nombre de la Lista</label>
                        <InputText class="form-control input-glass" @bind-Value="Lista.Nombre" placeholder="Ej: Precios Hoteles" />
                        <ValidationMessage For="(() => Lista.Nombre)" />
                    </div>
                    <div class="col-md-3">
                        <div class="form-check form-switch mt-4">
                            <InputCheckbox class="form-check-input" @bind-Value="Lista.Activa" />
                            <label class="form-check-label text-muted fw-bold">Lista Activa</label>
                        </div>
                    </div>
                </div>

                <hr class="text-muted opacity-25" />

                @* --- AGREGAR PRODUCTOS (DETALLE) --- *@
                <div class="row align-items-end mb-3 p-3 rounded-4" style="background-color: rgba(0,0,0,0.02);">
                    <div class="col-md-4">
                        <label class="form-label text-muted small fw-bold mb-1">Producto</label>
                        <InputSelect class="form-select input-glass" @bind-Value="DetalleSeleccionado.ProductoId">
                            <option value="0">-- Seleccionar --</option>
                            @foreach (var prod in ListaProductos)
                            {
                                <option value="@prod.ProductoId">@prod.NombreProducto ($@prod.Precio)</option>
                            }
                        </InputSelect>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-muted small fw-bold mb-1">Precio Mayorista</label>
                        <InputNumber class="form-control input-glass" @bind-Value="DetalleSeleccionado.PrecioMayorista" />
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-gradiente w-100" @onclick="AgregarDetalle">
                            <i class="bi bi-plus-lg"></i> Agregar
                        </button>
                    </div>
                </div>

                @* --- TABLA DETALLES --- *@
                <div class="table-responsive mt-3">
                    <table class="table table-hover bg-transparent align-middle">
                        <thead class="text-black" style="background-color: rgba(0,0,0,0.03); border-bottom: 2px solid rgba(0,0,0,0.1);">
                            <tr>
                                <th class="py-3 ps-3">Producto</th>
                                <th class="py-3 text-end">Precio Normal</th>
                                <th class="py-3 text-end">Precio Mayorista</th>
                                <th class="py-3 text-center">Quitar</th>
                            </tr>
                        </thead>
                        <tbody style="background-color: transparent;">
                            @foreach (var detalle in Lista.Detalles)
                            {
                                var prod = ListaProductos.FirstOrDefault(p => p.ProductoId == detalle.ProductoId);
                                <tr style="border-bottom: 1px solid rgba(0,0,0,0.05);">
                                    <td class="ps-3">@(prod?.NombreProducto ?? "N/A")</td>
                                    <td class="text-end text-muted text-decoration-line-through">$@(prod?.Precio.ToString("N2"))</td>
                                    <td class="text-end fw-bold" style="color: #3D5D35;">$@detalle.PrecioMayorista.ToString("N2")</td>
                                    <td class="text-center">
                                        <button type="button" class="btn btn-sm btn-outline-danger border-0 bi bi-trash3" @onclick="(() => RemoverDetalle(detalle))"></button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>

            @* --- FOOTER BOTONES --- *@
            <div class="card-footer bg-transparent border-top-0 text-center pb-3">
                <a href="/" class="btn btn-outline-secondary px-4 me-2">Volver</a>
                <button type="submit" class="btn btn-gradiente px-5">
                    <i class="bi bi-floppy"></i> Guardar Lista
                </button>
            </div>
        </div>
    </div>
</EditForm>

@code {
    /* ... (El código C# es el mismo que te pasé anteriormente) ... */
    /* Solo asegúrate de copiar la lógica del code block anterior aquí */

    public ListaPrecio Lista { get; set; } = new ListaPrecio();
    public ListaPrecioDetalle DetalleSeleccionado { get; set; } = new ListaPrecioDetalle();
    public List<Producto> ListaProductos { get; set; } = new List<Producto>();

    protected override async Task OnInitializedAsync()
    {
        ListaProductos = await productosService.Listar(p => p.ProductoId > 0);
    }

    public void AgregarDetalle()
    {
     

        Lista.Detalles.Add(new ListaPrecioDetalle
        {
            ProductoId = DetalleSeleccionado.ProductoId,
            PrecioMayorista = DetalleSeleccionado.PrecioMayorista
        });
        DetalleSeleccionado = new ListaPrecioDetalle();
    }

    public void RemoverDetalle(ListaPrecioDetalle detalle) => Lista.Detalles.Remove(detalle);

    public async Task Guardar()
    {
      
        if (await listasService.Guardar(Lista))
        {
           
            navigationManager.NavigateTo("/");
        }
       
    }
}