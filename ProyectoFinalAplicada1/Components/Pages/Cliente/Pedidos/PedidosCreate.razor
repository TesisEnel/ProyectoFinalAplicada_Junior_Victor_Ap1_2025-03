@page "/PedidoCliente/Create"
@rendermode InteractiveServer

@inject PedidosServices pedidosService
@inject ClientesServices clientesService
@inject CarritoService carritoService
@inject AuthenticationStateProvider authStateProvider
@inject NavigationManager navigationManager

<PageTitle>Confirmar Mi Pedido</PageTitle>

<div class="container mt-4">
    <div class="card card-glass rounded-4 p-2 shadow-lg">

        <div class="card-header bg-transparent border-bottom border-secondary border-opacity-10 pb-3">
            <h3 class="m-0 fw-bold text-success"><i class="bi bi-bag-check-fill"></i> Confirmar Pedido</h3>
            <small class="text-muted">Revisa tus datos y productos antes de finalizar.</small>
        </div>

        <EditForm Model="Pedido" OnValidSubmit="Guardar" FormName="ConfirmarPedidoCliente">
            <DataAnnotationsValidator />

            <div class="card-body">

                
                <div class="row mb-4">
                    <div class="col-md-12">
                        <h6 class="fw-bold text-muted mb-3 border-bottom pb-2">
                            <i class="bi bi-person-lines-fill"></i> Datos de Entrega
                        </h6>
                    </div>

                    
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted small fw-bold mb-1">Nombre</label>
                        <input type="text" class="form-control input-glass bg-light" value="@NombreClienteDisplay" readonly />
                    </div>

                  
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted small fw-bold mb-1">Teléfono</label>
                        <input type="text" class="form-control input-glass bg-light" value="@TelefonoClienteDisplay" readonly />
                    </div>

                  
                    <div class="col-md-12 mb-3">
                        <label class="form-label text-muted small fw-bold mb-1">Dirección / Referencia de Entrega</label>
                        <InputTextArea class="form-control input-glass" @bind-Value="Pedido.ReferenciaSitio" rows="2" placeholder="Ej: Casa azul, frente al parque..." />
                        <ValidationMessage For="(() => Pedido.ReferenciaSitio)" />
                        <div class="form-text text-muted small">
                            <i class="bi bi-info-circle"></i> Verifique que la dirección sea correcta para el delivery.
                        </div>
                    </div>

                  
                    <div class="col-md-12">
                        <div class="form-check form-switch p-3 bg-warning bg-opacity-10 rounded border border-warning border-opacity-25">
                            <InputCheckbox class="form-check-input"
                                           Value="Pedido.Delivery"
                                           ValueChanged="@((bool v) => AlCambiarDelivery(v))"
                                           ValueExpression="@(() => Pedido.Delivery)"
                                           style="cursor: pointer;" />
                            <label class="form-check-label fw-bold ms-2" for="chkDelivery">
                                <i class="bi bi-bicycle"></i> Solicitar Delivery (+RD$ 150.00)
                            </label>
                        </div>
                    </div>
                </div>

                
                <h6 class="fw-bold text-muted mb-3 border-bottom pb-2 mt-4">
                    <i class="bi bi-cart3"></i> Productos en Carrito
                </h6>

                <div class="table-responsive">
                    <table class="table table-hover bg-transparent align-middle">
                        <thead class="text-success bg-light">
                            <tr>
                                <th class="ps-3">Producto</th>
                                <th class="text-center">Precio</th>
                                <th class="text-center">Cant.</th>
                                <th class="text-end pe-3">Importe</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Pedido.Detalles)
                            {
                                <tr style="border-bottom: 1px solid rgba(0,0,0,0.05);">
                                    <td class="ps-3 fw-bold text-secondary">
                                        @item.Producto?.NombreProducto
                                    </td>
                                    <td class="text-center small">@item.PrecioUnitario.ToString("C2")</td>
                                    <td class="text-center fw-bold">@item.Cantidad</td>
                                    <td class="text-end pe-3 fw-bold text-success">@item.Importe.ToString("C2")</td>
                                </tr>
                            }
                            @if (!Pedido.Detalles.Any())
                            {
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-4">
                                        <i class="bi bi-basket fs-1 d-block text-muted opacity-25 mb-2"></i>
                                        No hay productos seleccionados.
                                        <br />
                                        <a href="/Tienda/Catalogo" class="btn btn-link">Ir al Catálogo</a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                        <tfoot class="bg-light bg-opacity-50 border-top border-success">
                            <tr>
                                <td colspan="3" class="text-end fw-bold pt-3">Subtotal:</td>
                                <td class="text-end pt-3 pe-3">@((Pedido.MontoTotal - (Pedido.Delivery ? 150 : 0)).ToString("C2"))</td>
                            </tr>
                            @if (Pedido.Delivery)
                            {
                                <tr class="text-muted small">
                                    <td colspan="3" class="text-end pt-1">Costo de Envío:</td>
                                    <td class="text-end pt-1 pe-3">+150.00</td>
                                </tr>
                            }
                            <tr>
                                <td colspan="3" class="text-end fw-bold fs-4 text-success pt-2">TOTAL A PAGAR:</td>
                                <td class="text-end fw-bold fs-4 text-success pt-2 pe-3">@Pedido.MontoTotal.ToString("C2")</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                @if (!string.IsNullOrEmpty(Mensaje))
                {
                    <div class="alert alert-info mt-3 text-center fw-bold shadow-sm">
                        <i class="bi bi-info-circle-fill"></i> @Mensaje
                    </div>
                }
            </div>

            @* --- FOOTER --- *@
            <div class="card-footer bg-transparent border-top-0 d-flex justify-content-between align-items-center mt-2 pt-0 pb-3 px-4">
                <a href="/Tienda/Catalogo" class="btn btn-outline-secondary px-4">
                    <i class="bi bi-arrow-left"></i> Seguir Comprando
                </a>
                <button type="submit" class="btn btn-gradiente px-5 py-3 shadow fs-5" disabled="@(!Pedido.Detalles.Any())">
                    <i class="bi bi-check-circle-fill"></i> Confirmar y Enviar
                </button>
            </div>
        </EditForm>
    </div>
</div>

@code {
    [SupplyParameterFromForm]
    public Pedido Pedido { get; set; } = new Pedido();

   
    public string NombreClienteDisplay { get; set; } = "Cargando...";
    public string TelefonoClienteDisplay { get; set; } = "";

    public string Mensaje { get; set; } = string.Empty;
    private const double COSTO_ENVIO = 150.00;

    protected override async Task OnInitializedAsync()
    {
        
        if (carritoService.Carrito.Any())
        {
            
            Pedido.Detalles = new List<PedidoDetalle>(carritoService.Carrito);
            CalcularTotal();
        }

        Pedido.FechaPedido = DateTime.Now;

        
        var authState = await authStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity != null && user.Identity.IsAuthenticated)
        {
            var nombreUsuario = user.Identity.Name; 
            var clienteEncontrado = await clientesService.BuscarPorCorreo(nombreUsuario ?? "");

            if (clienteEncontrado != null)
            {
                Pedido.ClienteId = clienteEncontrado.ClienteId;

                
                NombreClienteDisplay = $"{clienteEncontrado.NombreCliente} {clienteEncontrado.ApellidoCliente}";
                TelefonoClienteDisplay = clienteEncontrado.TelefonoCliente;

                
                if (string.IsNullOrEmpty(Pedido.ReferenciaSitio))
                {
                    Pedido.ReferenciaSitio = $"{clienteEncontrado.CalleCliente} #{clienteEncontrado.ViviendaCliente}, {clienteEncontrado.Sector} ({clienteEncontrado.DescripcionCliente})";
                }
            }
            else
            {
                Mensaje = "⚠️ No encontramos tus datos de cliente. Por favor contacta soporte.";
                NombreClienteDisplay = "Cliente No Registrado";
            }
        }
        else
        {
           
            navigationManager.NavigateTo("Account/Login");
        }
    }

    private void AlCambiarDelivery(bool valor)
    {
        Pedido.Delivery = valor;
        CalcularTotal();
    }

    private void CalcularTotal()
    {
        double subtotal = Pedido.Detalles.Sum(d => d.Importe);
        Pedido.MontoTotal = subtotal + (Pedido.Delivery ? COSTO_ENVIO : 0);
    }

    public async Task Guardar()
    {
        if (Pedido.ClienteId <= 0)
        {
            Mensaje = "Error: No se pudo identificar al cliente.";
            return;
        }
        if (!Pedido.Detalles.Any())
        {
            Mensaje = "El carrito está vacío.";
            return;
        }

       
        Pedido.Estado = "Pendiente";

        var guardado = await pedidosService.Guardar(Pedido);

        if (guardado)
        {
           
            carritoService.LimpiarCarrito();

            Mensaje = "¡Pedido enviado correctamente! 🎉 Te contactaremos pronto.";
            await Task.Delay(3000);
            navigationManager.NavigateTo("/"); 
        }
        else
        {
            Mensaje = "Hubo un error al procesar tu pedido. Intenta de nuevo.";
        }
    }
}