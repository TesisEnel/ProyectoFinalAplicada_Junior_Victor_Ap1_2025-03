@page "/PedidoCliente/Create"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@rendermode InteractiveServer
@inject ProyectoFinalAplicada1.DAL.Context _context
@inject AuthenticationStateProvider AuthenticationStateProvider

@inject PedidosServices pedidosService
@inject ClientesServices clientesService
@inject CarritoService carritoService
@inject AuthenticationStateProvider authStateProvider
@inject NavigationManager navigationManager

@attribute [Authorize(Roles = "Cliente")]

<PageTitle>Confirmar Mi Pedido</PageTitle>

<div class="container mt-4">
    <div class="card card-glass rounded-4 p-2 shadow-lg">

        <div class="card-header bg-transparent border-bottom border-secondary border-opacity-10 pb-3">
            <h3 class="m-0 fw-bold text-success"><i class="bi bi-bag-check-fill"></i> Confirmar Pedido</h3>
            <small class="text-muted">Revisa tus datos, método de pago y productos.</small>
        </div>

        <EditForm Model="Pedido" OnValidSubmit="Guardar" FormName="ConfirmarPedidoCliente">
            <DataAnnotationsValidator />

            <div class="card-body">

               
                <div class="row mb-4">
                    <div class="col-md-12">
                        <h6 class="fw-bold text-muted mb-3 border-bottom pb-2">
                            <i class="bi bi-person-lines-fill"></i> Datos de Entrega
                        </h6>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted small fw-bold mb-1">Nombre</label>
                        <InputText class="form-control input-glass bg-light" @bind-Value="NombreClienteDisplay" readonly />
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted small fw-bold mb-1">Teléfono</label>
                        <InputText class="form-control input-glass bg-light" @bind-Value="TelefonoClienteDisplay" readonly />
                    </div>

                    <div class="col-md-12 mb-3">
                        <label class="form-label text-muted small fw-bold mb-1">Dirección / Referencia</label>
                        <InputTextArea class="form-control input-glass" @bind-Value="Pedido.ReferenciaSitio" rows="2" placeholder="Ej: Calle Principal #10, Casa Azul..." />
                        <ValidationMessage For="(() => Pedido.ReferenciaSitio)" />
                    </div>

                    <div class="col-md-12">
                        <div class="form-check form-switch p-3 bg-warning bg-opacity-10 rounded border border-warning border-opacity-25 col-5 d-flex align-items-center">
    
                            <label class="form-check-label fw-bold me-auto" for="chkDelivery">
                                <i class="bi bi-bicycle"></i> Solicitar Delivery (+RD$ @CostoEnvio.ToString("N2"))
                            </label>

                            <InputCheckbox 
                                class="form-check-input ms-auto" 
                                @bind-Value="Pedido.Delivery" 
                                id="chkDelivery" 
                                style="cursor: pointer;" 
                                @oninput="ActualizarTotal" />

                        </div>
                    </div>
                </div>

               
                <div class="row mb-4">
                    <div class="col-md-12">
                        <h6 class="fw-bold text-muted mb-3 border-bottom pb-2">
                            <i class="bi bi-wallet2"></i> Método de Pago
                        </h6>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-bold">Seleccione cómo desea pagar:</label>
                        <InputSelect class="form-select input-glass fw-bold text-primary" @bind-Value="MetodoPagoSeleccionado">
                            <option value="Efectivo">💵 Efectivo (Contra Entrega)</option>
                            <option value="Transferencia">🏦 Transferencia Bancaria</option>
                        </InputSelect>
                    </div>

                    <div class="col-md-6">
                        @if (MetodoPagoSeleccionado == "Transferencia")
                        {
                            <div class="alert alert-info shadow-sm mb-0">
                                <small>
                                    <strong><i class="bi bi-info-circle"></i> Instrucciones:</strong><br />
                                    Su pedido quedará en estado <strong>Pendiente de Pago</strong>.
                                    Por favor realice la transferencia y envíe el comprobante vía WhatsApp o súbalo en su perfil.
                                </small>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-success shadow-sm mb-0">
                                <small>
                                    <strong><i class="bi bi-check-circle"></i> Efectivo:</strong><br />
                                    Pagará al momento de recibir su pedido.
                                </small>
                            </div>
                        }
                    </div>
                </div>

                
                <h6 class="fw-bold text-muted mb-3 border-bottom pb-2 mt-4">
                    <i class="bi bi-cart3"></i> Resumen de Productos
                </h6>

                <div class="table-responsive">
                    <table class="table table-hover bg-transparent align-middle">
                        <thead class="text-success bg-light">
                            <tr>
                                <th class="ps-3">Producto</th>
                                <th class="text-center">Precio</th>
                                <th class="text-center">Cant.</th>
                                <th class="text-end pe-3">Importe</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Pedido.Detalles)
                            {
                                <tr style="border-bottom: 1px solid rgba(0,0,0,0.05);">
                                    <td class="ps-3 fw-bold text-secondary">
                                        @item.Producto?.NombreProducto
                                    </td>
                                    <td class="text-center small">@item.PrecioUnitario.ToString("C2")</td>
                                    <td class="text-center fw-bold">@item.Cantidad</td>
                                    <td class="text-end pe-3 fw-bold text-success">@item.Importe.ToString("C2")</td>
                                </tr>
                            }
                        </tbody>
                        <tfoot class="bg-light bg-opacity-50 border-top border-success">
                            <tr>
                                <td colspan="3" class="text-end fw-bold pt-3">Subtotal:</td>
                                <td class="text-end pt-3 pe-3">@((Pedido.MontoTotal - (Pedido.Delivery ? CostoEnvio : 0)).ToString("C2"))</td>
                            </tr>
                            @if (Pedido.Delivery)
                            {
                                <tr class="text-muted small">
                                    <td colspan="3" class="text-end pt-1">Envío:</td>
                                    <td class="text-end pt-1 pe-3">+@CostoEnvio.ToString("N2")</td>
                                </tr>
                            }
                            <tr>
                                <td colspan="3" class="text-end fw-bold fs-4 text-success pt-2">TOTAL:</td>
                                <td class="text-end fw-bold fs-4 text-success pt-2 pe-3">@Pedido.MontoTotal.ToString("C2")</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                @if (!string.IsNullOrEmpty(Mensaje))
                {
                    <div class="alert alert-warning mt-3 text-center fw-bold shadow-sm">
                        <i class="bi bi-exclamation-triangle-fill"></i> @Mensaje
                    </div>
                }
            </div>

           
            <div class="card-footer bg-transparent border-top-0 d-flex justify-content-between align-items-center mt-2 pt-0 pb-3 px-4">
                <a href="/PedidoCliente/Index" class="btn btn-outline-secondary px-4">
                    <i class="bi bi-arrow-left"></i> Volver
                </a>
                <button type="submit" class="btn btn-gradiente px-5 py-3 shadow fs-5" disabled="@(!Pedido.Detalles.Any())">
                    <i class="bi bi-check-circle-fill"></i> Finalizar Pedido
                </button>
            </div>
        </EditForm>
    </div>
</div>

@code {
    [SupplyParameterFromForm]
    public Pedido Pedido { get; set; } = new Pedido();


    public int IdCliente { get; set; }


    public string MetodoPagoSeleccionado { get; set; } = "Efectivo";

    public string NombreClienteDisplay { get; set; } = "Cargando...";
    public string TelefonoClienteDisplay { get; set; } = "";

    public string Mensaje { get; set; } = string.Empty;

    public Cliente cliente { get; set; } 

    private const double CostoEnvio = 15.00;

    protected override async Task OnInitializedAsync()
    {
        IdCliente = await GetClienteIdAsync();
        if (await clientesService.Buscar(IdCliente) != null)
        {
            cliente = await clientesService.Buscar(IdCliente);
        }
        if (carritoService.Carrito.Any())
        {
            Pedido.Detalles = new List<PedidoDetalle>(carritoService.Carrito);
            CalcularTotal();

        }

        Pedido.FechaPedido = DateTime.Now;

        

        // var authState = await authStateProvider.GetAuthenticationStateAsync();
        // var user = authState.User;

        // if (user.Identity != null && user.Identity.IsAuthenticated)
        // {
        //     var nombreUsuario = user.Identity.Name;


        //     var clienteEncontrado = await clientesService.BuscarPorNombre(nombreUsuario ?? "");

        //     if (clienteEncontrado != null)
        //     {
        //         Pedido.ClienteId = clienteEncontrado.ClienteId;
        //         NombreClienteDisplay = $"{clienteEncontrado.NombreCliente} {clienteEncontrado.ApellidoCliente}";
        //         TelefonoClienteDisplay = clienteEncontrado.TelefonoCliente;


        //         if (string.IsNullOrEmpty(Pedido.ReferenciaSitio))
        //         {
        //             Pedido.ReferenciaSitio = $"{clienteEncontrado.CalleCliente} #{clienteEncontrado.ViviendaCliente}, {clienteEncontrado.Sector} ({clienteEncontrado.DescripcionCliente})";
        //         }
        //     }
        //     else
        //     {
        //         Mensaje = "No se encontraron datos del cliente asociado a este usuario.";
        //         NombreClienteDisplay = "Cliente Desconocido";
        //     }
        // }
        // else
        // {

        //     navigationManager.NavigateTo("Account/Login");
        // }

        NombreClienteDisplay = cliente.NombreCliente;
        TelefonoClienteDisplay = cliente.TelefonoCliente;
        Pedido.ReferenciaSitio = cliente.Sector + " / " + cliente.CalleCliente + " / " + cliente.ViviendaCliente + " / " + cliente.DescripcionCliente ;

    }

    public async Task<int> GetClienteIdAsync()
    {
        // 1. Obtener el GUID (Identity User ID)
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var identityId = authState.User
            .FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        if (string.IsNullOrEmpty(identityId))
        {
            return 0; // Usuario no logueado o ID no encontrado
        }

        // 2. Consultar la base de datos para obtener el ClienteId
        return await _context.Cliente
            .Where(c => c.UserId == identityId)
            .Select(c => c.ClienteId) // Selecciona solo el ClienteId
            .FirstOrDefaultAsync();    // Devuelve el ID (o 0 si no se encuentra)
    }

    private void ActualizarTotal(ChangeEventArgs e)
    {

        bool esDelivery = (bool)(e.Value ?? false);
        Pedido.Delivery = esDelivery;
        CalcularTotal();
    }

    private void CalcularTotal()
    {
        double subtotal = Pedido.Detalles.Sum(d => d.Importe);
        Pedido.MontoTotal = subtotal + (Pedido.Delivery ? CostoEnvio : 0);
    }

    public async Task Guardar()
    {
        if (Pedido.ClienteId <= 0)
        {
            Console.WriteLine("Si fun");

            return;
        }
        if (!Pedido.Detalles.Any())
        {
            Console.WriteLine("Si ");
            return;
        }


        if (MetodoPagoSeleccionado == "Transferencia")
        {
            Pedido.Estado = "Pendiente de Pago";


            Pedido.ReferenciaSitio += " [PAGO: TRANSFERENCIA]";
        }
        else
        {
            Pedido.Estado = "Pendiente"; 
            Pedido.ReferenciaSitio += " [PAGO: EFECTIVO]";
        }

        CalcularTotal();

        var guardado = await pedidosService.Guardar(Pedido);
        Console.WriteLine("Si funcionaaaaaaaaaaaaaa");
        if (guardado)
        {
            carritoService.LimpiarCarrito();
            await Task.Delay(2000);
            navigationManager.NavigateTo("/"); 
        }
       
    }
}