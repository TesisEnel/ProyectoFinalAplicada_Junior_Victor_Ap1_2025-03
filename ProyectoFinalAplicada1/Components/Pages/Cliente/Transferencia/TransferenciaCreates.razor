@page "/transferencias/crear"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore

@rendermode InteractiveServer
@inject IWebHostEnvironment WebHostEnvironment
@inject NavigationManager NavigationManager
@inject TranferenciaServices TransferenciaService
@inject PedidosServices pedidosServices
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ProyectoFinalAplicada1.DAL.Context _context

@attribute [Authorize(Roles = "Cliente")]

<h3>Nueva Transferencia Bancaria</h3>


    <div class="card p-4 shadow">

        <div class="row">

            <div class="col-6 mb-3">
                <label for="origen">Cuenta/Banco Origen <span class="text-danger">*</span></label>
                <InputSelect id="origen" class="form-select" @bind-Value="NuevaTransferencia.Origen">
                    <option value="">-- Seleccione un Banco --</option>
                    <option value="Banreservas">Banreservas</option>
                    <option value="Popular">Popular</option>
                    <option value="BHD">BHD</option>
                    <option value="Qik - Banco digital">Qik - Banco digital</option>
                </InputSelect>
                
            </div>

            <div class="col-6 mb-3">
                <label for="destino">Cuenta/Banco Destino <span class="text-danger">*</span></label>
                <InputSelect id="destino" class="form-select" @bind-Value="NuevaTransferencia.Destino">
                    <option value="">-- Seleccione un Banco --</option>
                    <option value="Banreservas">Banreservas</option>
                    <option value="Popular">Popular</option>
                    <option value="BHD">BHD</option>
                    <option value="Qik - Banco digital">Qik - Banco digital</option>
                </InputSelect>
                
            </div>
        </div>

        <div class="row">
            <div class="col-6 mb-3">
                <label for="monto">Monto Transferido <span class="text-danger">*</span></label>
                <InputNumber id="monto" class="form-control" @bind-Value="NuevaTransferencia.Monto" />
            </div>
            <div class="col-6 mb-3">
                <label for="fecha">Fecha de la Transferencia <span class="text-danger">*</span></label>
                <InputDate id="fecha" class="form-control" @bind-Value="NuevaTransferencia.Fecha" />
            </div>
        </div>


        <div class="col-6 mb-3">
            <label for="destino">Pedido a Pagar: <span class="text-danger">*</span></label>
            <InputSelect id="IdPedido" class="form-select" @bind-Value="IdPedido">
                <option value="">-- Seleccione un Pedido a Pagar --</option>
                @foreach(var p in ListaPedidos)
                {
                    <option value="@p.PedidoId">ID: @p.PedidoId - Fecha: @p.FechaPedido --- Monto a Pagar: @p.MontoTotal</option>
                }

            </InputSelect>
        </div>



        <div class="mb-3">
            <label for="observaciones">Observaciones <span class="text-danger">*</span></label>
            <InputTextArea id="observaciones" class="form-control" @bind-Value="NuevaTransferencia.Observaciones" />
        </div>
        <hr />
        <div class="card-body">
            <h4>📄 Adjuntar Comprobante(s)</h4>
            <div class="mb-3">
                <label>Seleccionar Imagen(es) (Máx @(MaxFileSize / 1024 / 1024)MB por archivo)</label>
                <InputFile OnChange="@HandleFileSelection" multiple />

                @if (selectedFiles.Count > 0)
                {
                    <p class="mt-2 text-success">**@selectedFiles.Count archivo(s) seleccionado(s) listo(s) para subir.**</p>
                }
                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="alert alert-danger mt-2">@errorMessage</div>
                }
            </div>
        </div>

        <div class="card-footer bg-transparent border-top-0 d-flex justify-content-between align-items-center mt-2 pt-0 pb-3 px-4">
            <a href="/TransferenciaCliente/Index" class="btn btn-outline-secondary px-4">
                <span class="bi bi-arrow-left"></span> Volver
            </a>
            <button type="button" class="btn btn-gradiente px-5" @onclick="GuardarTransferenciaCompleta">
                <span class="bi bi-floppy"></span> Guardar
            </button>
        </div>

    </div>


@code {

    public List<Pedido> ListaPedidos { get; set; } = new List<Pedido>();
    public Pedido pedido { get; set; } = new Pedido();
    public int IdCliente { get; set; }
    public int IdPedido { get; set; }

    protected override async Task OnInitializedAsync()
    {

        IdCliente = await GetClienteIdAsync();
        ListaPedidos = await pedidosServices.Listar(p => p.PedidoId > 0);
        ListaPedidos = ListaPedidos.Where(p => p.ClienteId == IdCliente).ToList();

    }

    private Transferencia NuevaTransferencia { get; set; } = new Transferencia
    {

        Imagenes = new List<TransferenciaImagen>()
    };
    private List<IBrowserFile> selectedFiles = new List<IBrowserFile>();
    private string? errorMessage;


    private const long MaxFileSize = 1024 * 1024 * 5;


    private void HandleFileSelection(InputFileChangeEventArgs e)
    {
        selectedFiles.Clear();
        errorMessage = null;

        foreach (var file in e.GetMultipleFiles())
        {
            if (file.Size > MaxFileSize)
            {
                errorMessage = $"El archivo '{file.Name}' excede el límite de 5MB.";
                selectedFiles.Clear();
                return;
            }
            selectedFiles.Add(file);
        }
    }

    public async Task<int> GetClienteIdAsync()
    {
        // 1. Obtener el GUID (Identity User ID)
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var identityId = authState.User
            .FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        if (string.IsNullOrEmpty(identityId))
        {
            return 0; // Usuario no logueado o ID no encontrado
        }

        // 2. Consultar la base de datos para obtener el ClienteId
        return await _context.Cliente
            .Where(c => c.UserId == identityId)
            .Select(c => c.ClienteId) // Selecciona solo el ClienteId
            .FirstOrDefaultAsync();    // Devuelve el ID (o 0 si no se encuentra)
    }

    private async Task GuardarTransferenciaCompleta()
    {
        string uploadsPath = Path.Combine(WebHostEnvironment.WebRootPath, "TransferenciaUploads");
        Directory.CreateDirectory(uploadsPath);
        foreach (var file in selectedFiles)
        {
            string uniqueFileName = Guid.NewGuid().ToString() + Path.GetExtension(file.Name);
            string fullServerPath = Path.Combine(uploadsPath, uniqueFileName);



            await using (var stream = new FileStream(fullServerPath, FileMode.Create))
            {

                await file.OpenReadStream(MaxFileSize).CopyToAsync(stream);
            }


            string relativeDbPath = $"/TransferenciaUploads/{uniqueFileName}";

            var imagenRegistro = new TransferenciaImagen
            {
                RutaImagen = relativeDbPath
            };


            NuevaTransferencia.Imagenes.Add(imagenRegistro);
        }
        NuevaTransferencia.PedidoId = IdPedido;

        bool guardado = await TransferenciaService.Guardar(NuevaTransferencia);

        if (guardado)
        {
            if (IdPedido != null)
            {
                pedido = await pedidosServices.Buscar(IdPedido);
                pedido.MontoTotal = -NuevaTransferencia.Monto;
                await pedidosServices.Guardar(pedido);

                pedido = new Pedido();
            }

            NavigationManager.NavigateTo("/transferencias");
        }
        else
        {
            errorMessage = "Error al guardar los datos en la base de datos. Los archivos físicos pudieron haberse guardado.";
        }
    }
}