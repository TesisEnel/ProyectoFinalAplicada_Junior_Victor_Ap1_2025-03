@page "/transferencias/crear"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using ProyectoFinalAplicada.Models
@using ProyectoFinalAplicada.Services

@rendermode InteractiveServer
@inject IWebHostEnvironment WebHostEnvironment
@inject NavigationManager NavigationManager
@inject TranferenciaServices TransferenciaService
@inject PedidosServices pedidosServices
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ProyectoFinalAplicada1.DAL.Context _context

@attribute [Authorize(Roles = "Cliente")]

<PageTitle>Registrar Transferencia</PageTitle>

<div class="container mt-4">
    <div class="card card-glass rounded-4 p-4 shadow-lg">
        <div class="card-header bg-transparent border-bottom-0">
            <h3 class="fw-bold text-primary"><i class="bi bi-bank"></i> Nueva Transferencia Bancaria</h3>
            <p class="text-muted">Registre su pago y adjunte el comprobante.</p>
        </div>

        <EditForm Model="NuevaTransferencia" OnValidSubmit="GuardarTransferenciaCompleta">
            <DataAnnotationsValidator />

            <div class="row">
                @* Bancos *@
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">Cuenta/Banco Origen <span class="text-danger">*</span></label>
                    <InputSelect class="form-select" @bind-Value="NuevaTransferencia.Origen">
                        <option value="">-- Seleccione --</option>
                        <option value="Banreservas">Banreservas</option>
                        <option value="Popular">Popular</option>
                        <option value="BHD">BHD</option>
                        <option value="Qik">Qik - Banco digital</option>
                    </InputSelect>
                    <ValidationMessage For="(() => NuevaTransferencia.Origen)" />
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">Cuenta/Banco Destino <span class="text-danger">*</span></label>
                    <InputSelect class="form-select" @bind-Value="NuevaTransferencia.Destino">
                        <option value="">-- Seleccione --</option>
                        <option value="Banreservas">Banreservas</option>
                        <option value="Popular">Popular</option>
                        <option value="BHD">BHD</option>
                        <option value="Qik">Qik - Banco digital</option>
                    </InputSelect>
                    <ValidationMessage For="(() => NuevaTransferencia.Destino)" />
                </div>

                @* Monto y Fecha *@
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">Monto Transferido <span class="text-danger">*</span></label>
                    <InputNumber class="form-control" @bind-Value="NuevaTransferencia.Monto" />
                    <ValidationMessage For="(() => NuevaTransferencia.Monto)" />
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">Fecha <span class="text-danger">*</span></label>
                    <InputDate class="form-control" @bind-Value="NuevaTransferencia.Fecha" />
                </div>

                @* Selección de Pedido (Opcional) *@
                <div class="col-md-12 mb-3">
                    <label class="form-label fw-bold">Asociar a Pedido (Opcional):</label>
                    <InputSelect class="form-select" @bind-Value="IdPedido">
                        <option value="0">-- Ninguno / Pago General --</option>
                        @foreach (var p in ListaPedidos)
                        {
                            <option value="@p.PedidoId">Pedido #@p.PedidoId - @p.FechaPedido.ToShortDateString() - Monto: @p.MontoTotal.ToString("C2")</option>
                        }
                    </InputSelect>
                    <small class="text-muted">Si selecciona un pedido, se actualizará su estado a "En Proceso" tras la verificación.</small>
                </div>

                @* Observaciones *@
                <div class="col-md-12 mb-3">
                    <label class="form-label fw-bold">Observaciones</label>
                    <InputTextArea class="form-control" @bind-Value="NuevaTransferencia.Observaciones" placeholder="Ej: Pago factura #123" />
                    <ValidationMessage For="(() => NuevaTransferencia.Observaciones)" />
                </div>
            </div>

            <hr />

            @* Carga de Imágenes *@
            <div class="mb-4">
                <h5 class="fw-bold"><i class="bi bi-paperclip"></i> Comprobante</h5>
                <div class="p-3 border rounded bg-light">
                    <label class="form-label">Seleccionar Imagen (Máx 5MB)</label>
                    <InputFile OnChange="@HandleFileSelection" class="form-control" multiple accept=".jpg,.jpeg,.png" />

                    @if (selectedFiles.Count > 0)
                    {
                        <div class="mt-2 text-success fw-bold">
                            <i class="bi bi-check-circle"></i> @selectedFiles.Count archivo(s) listo(s) para subir.
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger mt-2">@errorMessage</div>
                    }
                </div>
            </div>

            @* Botones *@
            <div class="d-flex justify-content-between">
                <a href="/PedidoCliente/Index" class="btn btn-outline-secondary px-4">
                    <i class="bi bi-arrow-left"></i> Volver
                </a>
                <button type="submit" class="btn btn-primary px-5 shadow">
                    <i class="bi bi-floppy"></i> Guardar Transferencia
                </button>
            </div>
        </EditForm>
    </div>
</div>

@code {
    public Transferencia NuevaTransferencia { get; set; } = new Transferencia { Fecha = DateTime.Now };
    public List<Pedido> ListaPedidos { get; set; } = new List<Pedido>();

    public int IdCliente { get; set; }
    public int IdPedido { get; set; } // Variable temporal para el select

    private List<IBrowserFile> selectedFiles = new List<IBrowserFile>();
    private string? errorMessage;
    private const long MaxFileSize = 1024 * 1024 * 5; // 5MB

    protected override async Task OnInitializedAsync()
    {
        // 1. OBTENER ID DEL CLIENTE LOGUEADO (Igual que en Pedidos)
        IdCliente = await GetClienteIdAsync();

        if (IdCliente > 0)
        {
            // 2. Cargar solo los pedidos de ESTE cliente
            ListaPedidos = await pedidosServices.Listar(p => p.ClienteId == IdCliente && (p.Estado == "Pendiente" || p.Estado == "Pendiente de Pago"));
        }
        else
        {
            errorMessage = "No se ha identificado un perfil de cliente para este usuario.";
        }
    }

    public async Task<int> GetClienteIdAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var identityId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        if (string.IsNullOrEmpty(identityId)) return 0;

        return await _context.Cliente
            .Where(c => c.UserId == identityId)
            .Select(c => c.ClienteId)
            .FirstOrDefaultAsync();
    }

    private void HandleFileSelection(InputFileChangeEventArgs e)
    {
        selectedFiles.Clear();
        errorMessage = null;
        foreach (var file in e.GetMultipleFiles())
        {
            if (file.Size > MaxFileSize)
            {
                errorMessage = $"El archivo '{file.Name}' es muy grande (Máx 5MB).";
                return;
            }
            selectedFiles.Add(file);
        }
    }

    private async Task GuardarTransferenciaCompleta()
    {
        if (IdCliente <= 0)
        {
            errorMessage = "Error: No hay cliente asociado.";
            return;
        }

        // 1. PROCESAR IMÁGENES FÍSICAS
        string uploadsPath = Path.Combine(WebHostEnvironment.WebRootPath, "TransferenciaUploads");
        if (!Directory.Exists(uploadsPath)) Directory.CreateDirectory(uploadsPath);

        // Limpiamos la lista previa para no duplicar si le dan guardar 2 veces
        NuevaTransferencia.Imagenes = new List<TransferenciaImagen>();

        foreach (var file in selectedFiles)
        {
            try
            {
                string uniqueFileName = Guid.NewGuid().ToString() + Path.GetExtension(file.Name);
                string fullServerPath = Path.Combine(uploadsPath, uniqueFileName);

                await using (var stream = new FileStream(fullServerPath, FileMode.Create))
                {
                    await file.OpenReadStream(MaxFileSize).CopyToAsync(stream);
                }

                // Ruta relativa para la BD
                NuevaTransferencia.Imagenes.Add(new TransferenciaImagen { RutaImagen = $"/TransferenciaUploads/{uniqueFileName}" });
            }
            catch (Exception ex)
            {
                errorMessage = $"Error al subir imagen: {ex.Message}";
                return;
            }
        }

        // 2. ASIGNAR DATOS CLAVE
        NuevaTransferencia.ClienteId = IdCliente; // <--- AQUÍ ESTÁ LA MAGIA

        // (Opcional) Si seleccionó un pedido, guardamos la referencia en observaciones si no hay campo PedidoId en Transferencia
        if (IdPedido > 0)
        {
            NuevaTransferencia.Observaciones += $" [Pago Pedido #{IdPedido}]";
        }

        // 3. GUARDAR EN BD
        // Usamos el método simple Guardar(modelo) porque ya llenamos el ClienteId manualmente arriba
        bool guardado = await TransferenciaService.Guardar(NuevaTransferencia);

        if (guardado)
        {
            // 4. ACTUALIZAR ESTADO DEL PEDIDO (Si aplica)
            if (IdPedido > 0)
            {
                var pedido = await pedidosServices.Buscar(IdPedido);
                if (pedido != null)
                {
                    // Cambiamos el estado para indicar que ya pagó/envió comprobante
                    pedido.Estado = "En Proceso";
                    // OJO: No restamos el monto total porque eso alteraría la factura.
                    // Lo correcto es cambiar el estado.

                    await pedidosServices.Guardar(pedido);
                }
            }

            NavigationManager.NavigateTo("/PedidoCliente/Index"); // Volver a mis pedidos
        }
        else
        {
            errorMessage = "Error al guardar en base de datos.";
        }
    }
}