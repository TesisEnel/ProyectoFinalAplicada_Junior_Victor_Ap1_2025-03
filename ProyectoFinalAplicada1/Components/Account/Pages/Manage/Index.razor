@page "/Account/Manage"

@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@using ProyectoFinalAplicada1.Data


@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject IdentityRedirectManager RedirectManager
@inject PageTitleService PageTitleService


<PageTitle>Mi Perfil</PageTitle>

<div class="d-flex align-items-center justify-content-center min-vh-100" style="margin-top: -60px;">

    <div class="col-md-10 col-lg-7 col-xl-6" style="margin-right: 15rem;">

        <StatusMessage />

        <div class="card card-neo p-4 text-center">

            <div class="neo-avatar-circle mb-2" style="width: 100px; height: 100px;">
                <img src="/imagenes/Logo.png" class="rounded-circle img-fluid" style="width: 100%; height: 100%; object-fit: cover;" />
            </div>

            <h4 class="fw-bold text-dark mt-1 mb-0">@username</h4>
            <p class="text-muted small mb-3" style="font-size: 0.8rem;">MIEMBRO CLUB DE POLLEROS</p>

            <div class="d-flex justify-content-center mb-3">
                <button class="neo-button" style="width: 40px; height: 40px; font-size: 16px;"><i class="bi bi-facebook"></i></button>
                <button class="neo-button" style="width: 40px; height: 40px; font-size: 16px;"><i class="bi bi-twitter-x"></i></button>
                <button class="neo-button" style="width: 40px; height: 40px; font-size: 16px;"><i class="bi bi-instagram"></i></button>
            </div>

            <EditForm Model="Input" FormName="profile" OnValidSubmit="OnValidSubmitAsync" method="post">
                <DataAnnotationsValidator />

                <div class="text-start px-3">
                    <div class="mb-3">
                        <label class="ms-3 mb-1 text-muted small fw-bold" style="font-size: 0.75rem;">USUARIO</label>
                        <input type="text" value="@username" class="form-control neo-input text-center py-2" disabled />
                    </div>

                    <div class="mb-4">
                        <label class="ms-3 mb-1 text-muted small fw-bold" style="color: #3D5D35; font-size: 0.75rem;">TELÉFONO</label>
                        <InputText @bind-Value="Input.PhoneNumber" class="form-control neo-input text-center py-2" placeholder="000-000-0000" />
                        <ValidationMessage For="() => Input.PhoneNumber" class="text-danger small ms-3 mt-1" />
                    </div>
                </div>

                <button type="submit" class="profile_button w-100 py-2">
                    GUARDAR CAMBIOS
                </button>

            </EditForm>
        </div>

    </div>
</div>

@code {
    private ApplicationUser? user;
    private string? username;
    private string? phoneNumber;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        PageTitleService.SetTitle("Mi Perfil");
        Input ??= new();
        user = await UserManager.GetUserAsync(HttpContext.User);
        if (user is null)
        {
            RedirectManager.RedirectToInvalidUser(UserManager, HttpContext);
            return;
        }
        username = await UserManager.GetUserNameAsync(user);
        phoneNumber = await UserManager.GetPhoneNumberAsync(user);
        Input.PhoneNumber ??= phoneNumber;
    }

    private async Task OnValidSubmitAsync()
    {
        if (user is null)
        {
            RedirectManager.RedirectToInvalidUser(UserManager, HttpContext);
            return;
        }
        if (Input.PhoneNumber != phoneNumber)
        {
            var setPhoneResult = await UserManager.SetPhoneNumberAsync(user, Input.PhoneNumber);
            if (!setPhoneResult.Succeeded)
            {
                RedirectManager.RedirectToCurrentPageWithStatus("Error: No se pudo guardar.", HttpContext);
                return;
            }
        }
        await SignInManager.RefreshSignInAsync(user);
        RedirectManager.RedirectToCurrentPageWithStatus("¡Perfil actualizado!", HttpContext);
    }

    private sealed class InputModel
    {
        [Phone]
        [Display(Name = "Phone number")]
        public string? PhoneNumber { get; set; }
    }
}